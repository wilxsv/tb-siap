{# src/MinsalCitasBundle/CitasMedicas/asignar.html.twig #}
{% extends 'SonataAdminBundle::layout.html.twig' %}
{% set idAreaModEstab = idAreaModEstab ? idAreaModEstab : '1' %}
{% set idProcedimientoEstablecimiento = app.request.query.has('idProcedimientoEstablecimiento') ? app.request.query.get('idProcedimientoEstablecimiento') : null %}
{% set rangoFechas    = app.request.query.has('rangoFechas') ? app.request.query.get('rangoFechas') : null %}

{% block stylesheets %}
    {{parent()}}
    <link rel="stylesheet" href="{{ asset('bundles/minsalsiaps/css/MntExpediente/list.css') }}" type="text/css" media="all" />
{% endblock%}

{% block javascripts %}
    {{parent()}}
    <script type="text/javascript">
    $(document).ready(function () {
        var idAreaModEstab = $('#idAreaModEstab');
        var idProcedimientoEstablecimiento = $('#idProcedimientoEstablecimiento');
        var now = moment();


        initializeSelect2(idAreaModEstab, true, false, {
            placeholder: 'Seleccione...',
            allowClear: true,
            width: '100%'
        });

        initializeSelect2(idProcedimientoEstablecimiento, true, true, {
            placeholder: 'Todos los procedimientos',
            allowClear: true,
            width: '100%'
        });

        idAreaModEstab.on('change', function () {
            initializeSelect2(idProcedimientoEstablecimiento, true, true, {
                placeholder: 'Todos los procedimientos',
                allowClear: true,
                width: '100%'
            });

            $('#resultado').empty();
            if ($(this).val()) {
                $.ajax({
                    url: Routing.generate("obtener_procedimientos_distribucion_area", {'idAreaModEstab': $(this).val()}),
                    async: false,
                    dataType: 'json',
                    success: function (data) {
                        $.each(data.resultados, function (indice, val) {
                            idProcedimientoEstablecimiento.append($('<option>', {value: val.id, text: val.text}));
                        });
                    }
                });
            }
        });

        idAreaModEstab.select2('val', '{{ idAreaModEstab }}').trigger('change');

        {% if idProcedimientoEstablecimiento != null %}
            idProcedimientoEstablecimiento.select2('val', '{{ idProcedimientoEstablecimiento }}');
        {% endif %}

        {% if rangoFechas != null %}
            $('#rango_fechas').val('{{ rangoFechas }}');
        {% else %}
            $('#rango_fechas').val(now.format('DD/MM/YYYY')+' - '+now.format('DD/MM/YYYY'));
        {% endif %}

        $('#limpiar').on('click', function(){
            $('#rango_fechas').val(now.format('DD/MM/YYYY')+' - '+now.format('DD/MM/YYYY'));
            initializeSelect2(idProcedimientoEstablecimiento, true, true, {
                placeholder: 'Todos los procedimientos',
                allowClear: true,
                width: '100%'
            });
            idAreaModEstab.trigger('change');
        });

        idProcedimientoEstablecimiento.on('change',function(){
            $('#resultado').empty();
        });

        $('#buscar').on('click',function(e){
            $('#resultado').load(Routing.generate("consulta_citas_procedimientos_por_dia",{'datos':$('#formBusqueda').serialize()}),
            function( response, status, xhr ) {
                $('#resultado').waitMe({ text: 'Buscando...' });
            });
        });

        if( idAreaModEstab.select2('val') !== '' && idProcedimientoEstablecimiento.select2('val') !== '' && $('#rango_fechas').val() !== '') {
            $('#buscar').trigger('click');
        }

        {% if not app.user.hasRole('ROLE_SUPER_ADMIN') %}
            idAreaModEstab.parent().parent().hide();
        {% endif %}
    });
    </script>
{% endblock %}

{% block notice %}
{% include 'SonataCoreBundle:FlashMessage:render.html.twig' %}
{% endblock notice %}

{% block list_table -%}

<div class="container-fluid">
    <div class="row">
        <form id="formBusqueda" method="post" >
            <div class="col-md-7 col-md-offset-2">
                <h2 class="text-center">Consulta de citas de procedimientos por día</h2>
                <img src="{{ asset('bundles/minsalcitas/imagenes/BuscarCita.png') }}" alt="imagen_buscar" style="width: 100px; margin: 20px auto; display:block;" />
                <table class="table table-bordered">
                    <tbody>
                        <tr>
                            <th>Rango de Fechas:</th>
                            <td><input type="text" id="rango_fechas" name="rango_fechas" class="bootstrap-daterangepicker" data-mask="99/99/9999 - 99/99/9999" placeholder='dd/mm/yyyy - dd/mm/yyyy' style="width:200px"></td>
                        </tr>
                      <tr>
                          <th style="width: 300px;">Área a la que pertenece el procedimiento:</th>
                          <td><select id="idAreaModEstab" name="idAreaModEstab" style="width:400px !important;">
                              {% for area in areas %}
                              <option value="{{ area.id }}">{{ area }}</option>
                              {% endfor %}
                          </select></td>
                      </tr>
                      <tr>
                          <th>Procedimiento:</th>
                          <td><select id="idProcedimientoEstablecimiento" name="idProcedimientoEstablecimiento" style="width:400px !important;"></select></input></td>
                      </tr>
                    </tbody>
                </table>
            </div>
        </form>
    </div>
    <div class="row">
        <div class="col-md-7 col-md-offset-2">
            <center>
                <button id="buscar" style="width: 160px; margin-top: 5px;" class="btn btn-primary" ><i class="glyphicon glyphicon-zoom-in"></i><strong>&nbsp; Buscar</strong></button>
                <a id="limpiar" style="width: 160px; margin-top: 5px;" class="btn btn-info" href="#"><i class="fa fa-trash-o"></i><strong>&nbsp; Limpiar</strong></a>
            </center>
        </div>
    </div>
    <br/>
    <div class="row">
<div id="resultado" class="col-md-10 center-block" style="min-height: 150px"></div>
</div>
{% endblock -%}
